name: Release (Dev)

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run the workflow without pushing"
        type: boolean
        default: false
        required: false
  push:
    branches:
      - main
    paths:
      - cmd/**
      - internal/**
      - pkg/**
      - go.mod
      - go.sum
      - main.go

jobs:
  Test:
    uses: ./.github/workflows/test.yaml
    permissions:
      contents: read

  Build-Binaries:
    needs: Test
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Go
        uses: actions/setup-go@8e57b58e57be52ac95949151e2777ffda8501267
        with:
          go-version: 1.24.x
          cache: true

      - name: Run GoReleaser for dev binaries
        uses: goreleaser/goreleaser-action@0931acf1f7634c2ee911eea11a334fb00a5180ab
        with:
          distribution: goreleaser
          version: "~> v2"
          args: build --snapshot --clean --config build/goreleaser/dev.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: dev-binaries
          path: |
            dist/*/watchtower*
            !dist/*.sbom

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: dev-sboms
          path: dist/*.sbom

  Build-and-Push-Per-Arch:
    needs: Build-Binaries
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: amd64
            arch_tag: amd64
            norm_arch: amd64_v1
          - platform: i386
            arch_tag: i386
            norm_arch: 386
          - platform: arm/v6
            arch_tag: armhf
            norm_arch: armv6
          - platform: arm64/v8
            arch_tag: arm64v8
            norm_arch: arm64_v8
          - platform: riscv64
            arch_tag: riscv64
            norm_arch: riscv64_rva20u64
    steps:
      - name: Checkout
        uses: actions/checkout@09d2acae674a48949e3602304ab46fd20ae0c42f
        with:
          fetch-depth: 0

      - name: Download binaries and SBOMs
        uses: actions/download-artifact@v4
        with:
          name: dev-binaries
          path: dist/

      - name: Set up QEMU
        uses: docker/setup-qemu-action@05340d1c670183e7caabdb33ae9f1c80fae3b0c2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

      - name: Login to Docker Hub
        if: github.event.inputs.dry_run != 'true'
        uses: docker/login-action@3d100841f68d4548bf57e52eb27bd33ec5069f55
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        if: github.event.inputs.dry_run != 'true'
        uses: docker/login-action@3d100841f68d4548bf57e52eb27bd33ec5069f55
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push per-arch image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
        with:
          context: .
          file: build/docker/Dockerfile.dev
          platforms: linux/${{ matrix.platform }}
          push: ${{ github.event.inputs.dry_run != 'true' }}
          tags: |
            nickfedor/watchtower:${{ matrix.arch_tag }}-dev
            ghcr.io/nicholas-fedor/watchtower:${{ matrix.arch_tag }}-dev
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            TARGETARCH=${{ matrix.norm_arch }}
            TARGETOS=linux

      - name: Attest per-arch GHCR dev image
        if: github.event.inputs.dry_run != 'true'
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-name: ghcr.io/${{ github.repository }}/${{ matrix.arch_tag }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Attest per-arch Docker Hub dev image
        if: github.event.inputs.dry_run != 'true'
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-name: docker.io/nickfedor/watchtower/${{ matrix.arch_tag }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

  Create-Manifest-and-Attest:
    needs: Build-and-Push-Per-Arch
    permissions:
      packages: write
      attestations: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Login to Docker Hub
        if: github.event.inputs.dry_run != 'true'
        uses: docker/login-action@3d100841f68d4548bf57e52eb27bd33ec5069f55
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        if: github.event.inputs.dry_run != 'true'
        uses: docker/login-action@3d100841f68d4548bf57e52eb27bd33ec5069f55
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifests
        if: github.event.inputs.dry_run != 'true'
        run: |
          ARCHES=("amd64" "i386" "armhf" "arm64v8" "riscv64")
          for repo in "nickfedor/watchtower" "ghcr.io/nicholas-fedor/watchtower"; do
            manifest="${repo}:latest-dev"
            images=()
            for arch in "${ARCHES[@]}"; do
              images+=("${repo}:${arch}-dev")
            done
            docker manifest create "$manifest" "${images[@]}"
            docker manifest push "$manifest"
          done

      - name: Get manifest digest for GHCR
        if: github.event.inputs.dry_run != 'true'
        id: digest-ghcr
        run: |
          digest=$(docker manifest inspect "ghcr.io/${{ github.repository }}:latest-dev" | jq -r '.Descriptor.digest')
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"

      - name: Attest GHCR manifest
        if: github.event.inputs.dry_run != 'true'
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.digest-ghcr.outputs.digest }}
          push-to-registry: true

      - name: Get manifest digest for Docker Hub
        if: github.event.inputs.dry_run != 'true'
        id: digest-docker
        run: |
          digest=$(docker manifest inspect "docker.io/nickfedor/watchtower:latest-dev" | jq -r '.Descriptor.digest')
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"

      - name: Attest Docker Hub manifest
        if: github.event.inputs.dry_run != 'true'
        uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be # v2
        with:
          subject-name: docker.io/nickfedor/watchtower
          subject-digest: ${{ steps.digest-docker.outputs.digest }}
          push-to-registry: true
