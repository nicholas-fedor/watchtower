name: Release Development

on:
  # Manual runs with option of dry-run (for testing CI pipeline)
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Run in test mode without publishing artifacts"
        required: false
        default: false
        type: boolean
  # Pushes to main with changes to code paths
  push:
    # On main branch pushes
    branches:
      - main
    # Watches cmd, internal, pkg, main.go, and Go modules
    paths:
      - cmd/**
      - internal/**
      - pkg/**
      - main.go
      - go.mod
      - go.sum

jobs:
  # Run Go tests and upload coverage
  test:
    uses: ./.github/workflows/test.yaml
    permissions:
      contents: read # For code checkout

  # Build binaries, images, SBOMs, and attestations
  build:
    needs: test # Requires tests to pass
    uses: ./.github/workflows/build.yaml
    permissions:
      contents: write # For code checkout and uploading release artifacts
      packages: write # For pushing images to registries
      attestations: write # For generating provenance and SBOMs
      id-token: write # For OIDC auth to Docker Hub and GHCR
    with:
      build-type: dev # Development snapshot release
      dry-run: ${{ fromJson(inputs.dry-run || 'false') }} # String to boolean, defaults false
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }} # Docker Hub username
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }} # Docker Hub token

  # Generate and commit changelog
  changelog:
    # Runs after build
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write # For committing changelog
    steps:
      - name: Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --verbose
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit changelog
        if: ${{ !fromJson(inputs.dry-run || 'false') }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add CHANGELOG.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update changelog"
            git push
          fi

  # Create multi-platform manifests
  manifest:
    # Runs after build and changelog
    needs: [build, changelog]
    # Skips in dry-run
    if: ${{ !fromJson(inputs.dry-run || 'false') }}
    permissions:
      contents: read # For code checkout
      packages: write # For pushing manifests
    uses: ./.github/workflows/create-manifests.yaml
    secrets: inherit
    with:
      build-type: dev # Tags images as latest-dev
