name: Release Production

on:
  # Manual runs with option of dry-run (for testing CI pipeline)
  workflow_dispatch:
    inputs:
      dry-run:
        description: "Run in test mode without publishing artifacts"
        required: false
        default: false
        type: boolean
  # Tag pushes (e.g., v1.2.3)
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+" # Semantic version tags

jobs:
  # Run Go tests and upload coverage
  test:
    uses: ./.github/workflows/test.yaml
    permissions:
      contents: read # For code checkout

  # Generate changelog for release
  changelog:
    # Runs after test
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write # For repository checkout, git-cliff, and creating PR
      pull-requests: write # For creating PR
    steps:
      - name: Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          ref: 'main'
          fetch-depth: 0

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Generate Changelog
        uses: orhun/git-cliff-action@d77b37db2e3f7398432d34b72a12aa3e2ba87e51 # v4
        with:
          config: cliff.toml
          args: --verbose
        env:
          OUTPUT: CHANGELOG.md
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.CHANGELOG_PAT }}

      - name: Create Pull Request for Changelog
        if: ${{ !fromJson(inputs.dry-run || 'false') }}
        uses: peter-evans/create-pull-request@d3e081a03ae8d69301ed924bae10d70ea4af94d9
        with:
          token: ${{ secrets.CHANGELOG_PAT }}
          committer: Nick Fedor <nick@nickfedor.com>
          title: "docs(changelog): update changelog for ${{ github.ref_name }}"
          commit-message: "docs(changelog): update changelog for ${{ github.ref_name }}"
          body: "Automated changelog update for release ${{ github.ref_name }}"
          branch: docs/update-changelog-${{ github.ref_name }}
          delete-branch: true

  # Build binaries, images, SBOMs, and attestations
  build:
    needs: [test, changelog] # Requires tests to pass and changelog to be generated
    uses: ./.github/workflows/build.yaml
    permissions:
      contents: write # For code checkout and publishing releases
      packages: write # For pushing images to registries
      attestations: write # For generating provenance and SBOMs
      id-token: write # For OIDC auth to Docker Hub and GHCR
    with:
      build-type: prod # Production release.
      dry-run: ${{ fromJson(inputs.dry-run || 'false') }} # String to boolean, defaults false
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }} # Docker Hub username
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }} # Docker Hub token

  # Create multi-platform manifests
  manifest:
    # Runs after build
    needs: build
    # Skips in dry-run
    if: ${{ !fromJson(inputs.dry-run || 'false') }}
    permissions:
      contents: read # For code checkout
      packages: write # For pushing manifests
    uses: ./.github/workflows/create-manifests.yaml
    secrets: inherit
    with:
      build-type: prod # Tags images with version and latest
      version: ${{ github.ref_name }} # Tag name (e.g., v1.2.3)

  # Update pkg.go.dev
  update-go-docs:
    # Runs after all jobs
    needs: [test, build, manifest, changelog]
    # Skips in dry-run
    if: ${{ !fromJson(inputs.dry-run || 'false') }}
    permissions:
      contents: read # For code checkout
    uses: ./.github/workflows/update-go-docs.yaml
